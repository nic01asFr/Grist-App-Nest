<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grist Dynamic Dashboard - v2.5 DEBUG</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            height: 100vh;
            display: grid;
            grid-template-rows: 60px 1fr;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1000;
        }
        
        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .version-badge {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .security-badge {
            background: #f59e0b;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 5px;
        }
        
        .nav {
            margin-left: auto;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .nav-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .nav-btn.active {
            background: rgba(255,255,255,0.4);
            font-weight: 600;
        }
        
        .control-buttons {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }
        
        .control-btn {
            background: #f59e0b;
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .control-btn.security {
            background: #10b981;
        }
        
        .control-btn:hover {
            opacity: 0.8;
        }
        
        .main {
            position: relative;
            overflow: hidden;
        }
        
        .iframe-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1;
        }
        
        .iframe-container.active {
            opacity: 1;
            z-index: 2;
        }
        
        .dynamic-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #64748b;
            z-index: 10;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            max-width: 400px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #fee2e2;
            color: #dc2626;
            padding: 20px;
            border-radius: 8px;
            margin: 20px;
            border-left: 4px solid #dc2626;
            z-index: 100;
            position: relative;
        }
        
        .status-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            z-index: 1001;
        }
        
        .status-loading { background: #fbbf24; color: #92400e; }
        .status-ready { background: #10b981; color: white; }
        .status-error { background: #ef4444; color: white; }
        .status-grist { background: #8b5cf6; color: white; }
        .status-secure { background: #059669; color: white; }
        .status-validating { background: #3b82f6; color: white; }
        .status-debug { background: #f59e0b; color: white; }
        
        .debug-info {
            font-size: 12px;
            background: #f3f4f6;
            border-radius: 6px;
            padding: 10px;
            margin-top: 15px;
            text-align: left;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px;
            animation: progress 3s ease-in-out infinite;
        }
        
        @keyframes progress {
            0% { width: 0%; }
            50% { width: 70%; }
            100% { width: 100%; }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1 id="app-title">üîí Dashboard Dynamique Grist <span class="version-badge">v2.5</span><span class="security-badge">DEBUG</span></h1>
        <nav class="nav" id="navigation"></nav>
        <div class="control-buttons">
            <button class="control-btn security" id="security-btn">üîí MODERATE</button>
            <button class="control-btn" id="debug-btn">üêõ Debug ON</button>
        </div>
    </header>
    
    <main class="main" id="main-content">
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div id="loading-text">Initialisation du syst√®me de debug...</div>
            <div class="progress-bar">
                <div class="progress-fill"></div>
            </div>
            <div class="debug-info" id="debug-info">
                <div>üîç Mode debug activ√©</div>
                <div>üìä Chargement des diagnostics...</div>
            </div>
        </div>
        <div class="status-indicator status-debug" id="status">Debug Mode</div>
    </main>

    <script>
        // DEBUG MODE FORC√â - Variables globales avec monitoring
        window.dashboardDebugMode = true;
        window.dashboard = null;
        window.securityLevel = 'moderate';
        window.debugSteps = [];
        window.compilationErrors = [];

        // LOGGER DE DEBUG RENFORC√â
        function debugLog(step, message, data, isError = false) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                timestamp,
                step,
                message,
                data: data || null,
                isError
            };
            
            window.debugSteps.push(logEntry);
            
            const prefix = isError ? '‚ùå' : '‚úÖ';
            console.log(`[${timestamp}] ${prefix} ${step}: ${message}`, data || '');
            
            // Mise √† jour de l'interface de debug
            updateDebugDisplay();
        }

        function updateDebugDisplay() {
            const debugInfo = document.getElementById('debug-info');
            if (!debugInfo) return;
            
            const lastSteps = window.debugSteps.slice(-5);
            const html = lastSteps.map(step => {
                const icon = step.isError ? '‚ùå' : '‚úÖ';
                return `<div>${icon} ${step.timestamp} - ${step.step}: ${step.message}</div>`;
            }).join('');
            
            debugInfo.innerHTML = html;
        }

        // FALLBACK TEMPLATE INT√âGR√â
        function createFallbackTemplate() {
            debugLog('FALLBACK', 'Cr√©ation du template de fallback');
            return {
                id: 'fallback_debug',
                name: 'üîß Debug Fallback',
                type: 'debug',
                html: `
                    <div style="padding: 30px; max-width: 800px; margin: 0 auto; font-family: Arial, sans-serif;">
                        <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <h1 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                                üîß Mode Debug Actif v2.5
                            </h1>
                            <p style="margin: 10px 0 0; opacity: 0.9;">
                                Diagnostics en cours - Template de fallback charg√©
                            </p>
                        </div>
                        
                        <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 15px; color: #374151;">üìã √âtat du Syst√®me</h3>
                            <div id="system-status">Chargement des diagnostics...</div>
                        </div>
                        
                        <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 15px; color: #374151;">üîç √âtapes de Debug</h3>
                            <div id="debug-steps" style="font-family: monospace; font-size: 13px; background: #f8fafc; padding: 15px; border-radius: 6px; max-height: 200px; overflow-y: auto;">
                                Initialisation du debug...
                            </div>
                        </div>
                        
                        <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 15px; color: #374151;">‚ö° Actions de Debug</h3>
                            <button onclick="testGristConnection()" style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-right: 10px;">
                                üîå Test Connexion Grist
                            </button>
                            <button onclick="testTemplateCompilation()" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-right: 10px;">
                                ‚öôÔ∏è Test Compilation
                            </button>
                            <button onclick="reloadSystem()" style="background: #f59e0b; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                                üîÑ Reload Syst√®me
                            </button>
                        </div>
                        
                        <div style="background: #fee2e2; border-radius: 8px; padding: 20px; border-left: 4px solid #dc2626;">
                            <h3 style="margin: 0 0 10px; color: #dc2626;">‚ö†Ô∏è Instructions de Debug</h3>
                            <ol style="margin: 0; padding-left: 20px; color: #7f1d1d;">
                                <li>V√©rifiez la console pour les erreurs JavaScript</li>
                                <li>Testez la connexion Grist avec le bouton ci-dessus</li>
                                <li>Si probl√®me persistant: Ctrl+Shift+R pour vider le cache</li>
                                <li>Essayez en mode navigation priv√©e</li>
                            </ol>
                        </div>
                    </div>
                `,
                css: '',
                js: `
                    debugLog('FALLBACK_JS', 'JavaScript du template fallback ex√©cut√©');
                    
                    window.testGristConnection = function() {
                        debugLog('TEST', 'Test de connexion Grist en cours...');
                        
                        if (typeof grist === 'undefined') {
                            debugLog('TEST', 'API Grist non disponible', null, true);
                            updateSystemStatus('‚ùå API Grist non trouv√©e');
                            return;
                        }
                        
                        grist.ready().then(() => {
                            debugLog('TEST', 'Connexion Grist OK');
                            updateSystemStatus('‚úÖ Connexion Grist √©tablie');
                            
                            return grist.docApi.fetchTable('Templates');
                        }).then(templates => {
                            debugLog('TEST', 'Templates charg√©s', { count: templates.length });
                            updateSystemStatus('‚úÖ Templates: ' + templates.length + ' trouv√©s');
                        }).catch(error => {
                            debugLog('TEST', 'Erreur test Grist', error, true);
                            updateSystemStatus('‚ùå Erreur: ' + error.message);
                        });
                    };
                    
                    window.testTemplateCompilation = function() {
                        debugLog('COMPILATION', 'Test de compilation...');
                        
                        const testTemplate = {
                            id: 'test',
                            html: '<div>Test HTML</div>',
                            css: 'div { color: blue; }',
                            js: 'console.log("Test JS");'
                        };
                        
                        try {
                            const compiled = window.dashboard?.secureProcessor?.compileSecureTemplate(testTemplate);
                            if (compiled && compiled.length > 100) {
                                debugLog('COMPILATION', 'Compilation r√©ussie');
                                updateSystemStatus('‚úÖ Compilation OK');
                            } else {
                                debugLog('COMPILATION', 'Compilation √©chou√©e', null, true);
                                updateSystemStatus('‚ùå Compilation √©chou√©e');
                            }
                        } catch (error) {
                            debugLog('COMPILATION', 'Erreur compilation', error, true);
                            updateSystemStatus('‚ùå Erreur compilation: ' + error.message);
                        }
                    };
                    
                    window.reloadSystem = function() {
                        debugLog('RELOAD', 'Rechargement du syst√®me...');
                        location.reload();
                    };
                    
                    function updateSystemStatus(status) {
                        const el = document.getElementById('system-status');
                        if (el) el.innerHTML = status;
                    }
                    
                    function updateDebugStepsDisplay() {
                        const el = document.getElementById('debug-steps');
                        if (el && window.debugSteps) {
                            const html = window.debugSteps.slice(-10).map(step => {
                                const icon = step.isError ? '‚ùå' : '‚úÖ';
                                return icon + ' [' + step.timestamp + '] ' + step.step + ': ' + step.message;
                            }).join('\\n');
                            el.textContent = html;
                        }
                    }
                    
                    // Mise √† jour p√©riodique
                    setInterval(updateDebugStepsDisplay, 1000);
                    
                    debugLog('FALLBACK_READY', 'Template fallback pr√™t');
                `
            };
        }

        // PROCESSEUR S√âCURIS√â AVEC DEBUG RENFORC√â
        class SecureTemplateProcessor {
            constructor() {
                debugLog('PROCESSOR', 'Initialisation SecureTemplateProcessor');
                this.securityLevels = {
                    STRICT: 'strict',
                    MODERATE: 'moderate', 
                    PERMISSIVE: 'permissive'
                };
                this.currentLevel = this.securityLevels.MODERATE;
            }

            validateRawTemplate(template) {
                debugLog('VALIDATION', 'Validation template: ' + (template.template_id || 'unknown'));
                const result = { valid: true, errors: [], warnings: [], cleaned: null };

                try {
                    if (!template || typeof template !== 'object') {
                        result.valid = false;
                        result.errors.push('Template invalide ou manquant');
                        debugLog('VALIDATION', 'Template invalide', template, true);
                        return result;
                    }

                    const cleanedTemplate = this.cleanGristColumns(template);
                    
                    const htmlValidation = this.validateHTML(cleanedTemplate.html || '');
                    const cssValidation = this.validateCSS(cleanedTemplate.css || '');
                    const jsValidation = this.validateJavaScript(cleanedTemplate.js || '');

                    result.errors.push(...htmlValidation.errors, ...cssValidation.errors, ...jsValidation.errors);
                    result.warnings.push(...htmlValidation.warnings, ...cssValidation.warnings, ...jsValidation.warnings);
                    
                    if (result.errors.length > 0) {
                        result.valid = false;
                        debugLog('VALIDATION', 'Erreurs trouv√©es', result.errors, true);
                    } else {
                        debugLog('VALIDATION', 'Template valid√© avec succ√®s');
                    }

                    result.cleaned = {
                        id: cleanedTemplate.template_id || 'unknown',
                        name: cleanedTemplate.template_name || 'Unnamed',
                        type: cleanedTemplate.type || 'page',
                        table_source: cleanedTemplate.table_source || '',
                        html: htmlValidation.cleaned,
                        css: cssValidation.cleaned,
                        js: jsValidation.cleaned
                    };

                } catch (error) {
                    result.valid = false;
                    result.errors.push('Erreur validation: ' + error.message);
                    debugLog('VALIDATION', 'Exception validation', error, true);
                }

                return result;
            }

            cleanGristColumns(template) {
                const cleaned = {};
                for (const [key, value] of Object.entries(template)) {
                    if (key !== 'A' && key !== 'B' && value !== '' && value !== null && value !== undefined) {
                        cleaned[key] = value;
                    }
                }
                return cleaned;
            }

            validateHTML(html) {
                const result = { valid: true, errors: [], warnings: [], cleaned: '' };
                
                if (!html || typeof html !== 'string') {
                    result.cleaned = '<div style="padding: 20px; text-align: center;">Template HTML vide</div>';
                    return result;
                }

                try {
                    let cleanedHTML = html;

                    if (html.length > 50000) {
                        result.errors.push('HTML trop long');
                        return result;
                    }

                    // Nettoyage s√©curis√© plus prudent
                    cleanedHTML = cleanedHTML.replace(/<(script|iframe|object|embed|form)[^>]*>.*?<\/\1>/gi, '');
                    cleanedHTML = cleanedHTML.replace(/\s(on\w+|href\s*=\s*["']javascript:|src\s*=\s*["']javascript:)[^>]*/gi, '');
                    cleanedHTML = this.normalizeWhitespace(cleanedHTML);
                    
                    result.cleaned = cleanedHTML;

                } catch (error) {
                    result.errors.push('Erreur validation HTML');
                    result.cleaned = '<div class="error">Erreur HTML</div>';
                    debugLog('HTML_VALIDATION', 'Erreur validation HTML', error, true);
                }

                return result;
            }

            validateCSS(css) {
                const result = { valid: true, errors: [], warnings: [], cleaned: '' };
                
                if (!css || typeof css !== 'string') {
                    return result;
                }

                try {
                    let cleanedCSS = css;

                    if (css.length > 10000) {
                        result.errors.push('CSS trop long');
                        return result;
                    }

                    // Nettoyage s√©curis√©
                    cleanedCSS = cleanedCSS.replace(/@import\s+.*?(javascript:|expression\()|expression\s*\(|url\s*\(\s*["']?(javascript:|data:)/gi, '/* blocked */');
                    cleanedCSS = this.normalizeWhitespace(cleanedCSS);
                    result.cleaned = cleanedCSS;

                } catch (error) {
                    result.errors.push('Erreur validation CSS');
                    debugLog('CSS_VALIDATION', 'Erreur validation CSS', error, true);
                }

                return result;
            }

            validateJavaScript(js) {
                const result = { valid: true, errors: [], warnings: [], cleaned: '' };
                
                if (!js || typeof js !== 'string') {
                    return result;
                }

                try {
                    let cleanedJS = js;

                    if (js.length > 100000) {
                        result.errors.push('JavaScript trop long');
                        return result;
                    }

                    cleanedJS = this.cleanAccentedCharacters(cleanedJS);

                    // V√©rifications de s√©curit√©
                    if (/\b(eval|Function|setTimeout\s*\([^,]*string|setInterval\s*\([^,]*string)\s*\(/gi.test(cleanedJS)) {
                        result.warnings.push('Fonctions dangereuses d√©tect√©es');
                        if (this.currentLevel === this.securityLevels.STRICT) {
                            result.errors.push('Code JavaScript non s√©curis√©');
                            return result;
                        }
                    }

                    cleanedJS = cleanedJS.replace(/\b(parent\.|top\.|opener\.)/gi, 'blocked.');

                    const syntaxValidation = this.validateJSSyntax(cleanedJS);
                    if (!syntaxValidation.valid) {
                        result.warnings.push('Syntaxe corrig√©e');
                        cleanedJS = 'try { ' + cleanedJS + ' } catch(error) { console.error("Template error:", error); }';
                        debugLog('JS_VALIDATION', 'Syntaxe JS corrig√©e', syntaxValidation.error);
                    }

                    cleanedJS = this.normalizeWhitespace(cleanedJS);
                    result.cleaned = cleanedJS;

                } catch (error) {
                    result.errors.push('Erreur validation JS');
                    result.cleaned = 'console.error("Template JS error");';
                    debugLog('JS_VALIDATION', 'Erreur validation JS', error, true);
                }

                return result;
            }

            cleanAccentedCharacters(text) {
                const charMap = {
                    '√©': 'e', '√®': 'e', '√™': 'e', '√´': 'e', '√†': 'a', '√°': 'a', '√¢': 'a', '√§': 'a',
                    '√π': 'u', '√∫': 'u', '√ª': 'u', '√º': 'u', '√¨': 'i', '√≠': 'i', '√Æ': 'i', '√Ø': 'i',
                    '√≤': 'o', '√≥': 'o', '√¥': 'o', '√∂': 'o', '√ß': 'c', '√±': 'n',
                    '"': '"', '"': '"', ''': "'", ''': "'"
                };
                
                let cleaned = text;
                for (const [accented, clean] of Object.entries(charMap)) {
                    cleaned = cleaned.replace(new RegExp(accented, 'g'), clean);
                }
                
                cleaned = cleaned.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '');
                return cleaned;
            }

            validateJSSyntax(js) {
                try {
                    new Function(js);
                    return { valid: true, error: null };
                } catch (error) {
                    return { valid: false, error: error.message };
                }
            }

            normalizeWhitespace(text) {
                return text.replace(/\s+/g, ' ').replace(/\n\s*\n/g, '\n').trim();
            }

            // COMPILATION S√âCURIS√âE AVEC DEBUG
            compileSecureTemplate(template) {
                debugLog('COMPILATION', 'D√©but compilation template: ' + template.id);
                
                try {
                    const html = template.html || '<div>Template vide</div>';
                    const css = template.css || '';
                    const js = template.js || '';
                    
                    debugLog('COMPILATION', 'Contenu √† compiler', {
                        htmlLength: html.length,
                        cssLength: css.length,
                        jsLength: js.length
                    });
                    
                    const securityColor = this.getSecurityColor();
                    const gristScript = this.generateSecureGristAPI();
                    
                    // ASSEMBLAGE ULTRA-S√âCURIS√â
                    const doctype = '<!DOCTYPE html>';
                    const htmlOpen = '<html lang="fr">';
                    const headOpen = '<head>';
                    const charset = '<meta charset="UTF-8">';
                    const viewport = '<meta name="viewport" content="width=device-width, initial-scale=1.0">';
                    const title = '<title>Secure Template ' + this.escapeHtml(template.id) + '</title>';
                    const gristScriptTag = '<script src="https://docs.getgrist.com/grist-plugin-api.js"></script>';
                    const styleOpen = '<style>';
                    const baseStyles = this.getBaseStyles();
                    const securityInfoStyle = '.security-info { position: fixed; top: 10px; right: 10px; background: ' + securityColor + '; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; z-index: 1000; }';
                    const customStyles = css;
                    const styleClose = '</style>';
                    const headClose = '</head>';
                    const bodyOpen = '<body>';
                    const securityInfo = '<div class="security-info">üîí ' + this.currentLevel.toUpperCase() + '</div>';
                    const content = html;
                    const scriptOpen = '<script>';
                    const logStatement = 'console.log("üîí Secure Template: ' + this.escapeJs(template.id) + '");';
                    const wrapperOpen = '(function() {';
                    const strictMode = '"use strict";';
                    const templateCode = js;
                    const wrapperClose = '})();';
                    const scriptClose = '</script>';
                    const bodyClose = '</body>';
                    const htmlClose = '</html>';

                    // Assemblage par concat√©nation simple
                    let compiledDocument = '';
                    compiledDocument += doctype + '\n';
                    compiledDocument += htmlOpen + '\n';
                    compiledDocument += headOpen + '\n';
                    compiledDocument += charset + '\n';
                    compiledDocument += viewport + '\n';
                    compiledDocument += title + '\n';
                    compiledDocument += gristScriptTag + '\n';
                    compiledDocument += styleOpen + '\n';
                    compiledDocument += baseStyles + '\n';
                    compiledDocument += securityInfoStyle + '\n';
                    compiledDocument += customStyles + '\n';
                    compiledDocument += styleClose + '\n';
                    compiledDocument += headClose + '\n';
                    compiledDocument += bodyOpen + '\n';
                    compiledDocument += securityInfo + '\n';
                    compiledDocument += content + '\n';
                    compiledDocument += scriptOpen + '\n';
                    compiledDocument += logStatement + '\n';
                    compiledDocument += gristScript + '\n';
                    compiledDocument += wrapperOpen + '\n';
                    compiledDocument += strictMode + '\n';
                    compiledDocument += templateCode + '\n';
                    compiledDocument += wrapperClose + '\n';
                    compiledDocument += scriptClose + '\n';
                    compiledDocument += bodyClose + '\n';
                    compiledDocument += htmlClose;
                    
                    debugLog('COMPILATION', 'Compilation r√©ussie', { 
                        finalLength: compiledDocument.length,
                        containsScript: compiledDocument.includes('<script>'),
                        containsHtml: compiledDocument.includes('<!DOCTYPE html>')
                    });
                    
                    return compiledDocument;

                } catch (error) {
                    debugLog('COMPILATION', 'Erreur compilation', error, true);
                    window.compilationErrors.push(error);
                    return this.buildErrorDocument(error.message);
                }
            }

            getSecurityColor() {
                switch (this.currentLevel) {
                    case 'strict': return '#dc2626';
                    case 'moderate': return '#f59e0b';
                    case 'permissive': return '#10b981';
                    default: return '#6b7280';
                }
            }

            getBaseStyles() {
                return 'body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #ffffff; }';
            }

            escapeHtml(text) {
                if (!text) return '';
                return String(text)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#x27;');
            }

            escapeJs(text) {
                if (!text) return '';
                return String(text)
                    .replace(/\\/g, '\\\\')
                    .replace(/"/g, '\\"')
                    .replace(/'/g, "\\'")
                    .replace(/\n/g, '\\n')
                    .replace(/\r/g, '\\r');
            }

            generateSecureGristAPI() {
                debugLog('API_GENERATION', 'G√©n√©ration de l\'API Grist s√©curis√©e');
                
                const line1 = 'window.gristAPI = {';
                const line2 = '  async getData(tableName) {';
                const line3 = '    try {';
                const line4 = '      if (typeof tableName !== "string" || tableName.length > 50) {';
                const line5 = '        throw new Error("Table name invalid");';
                const line6 = '      }';
                const line7 = '      const data = await parent.window.grist.docApi.fetchTable(tableName);';
                const line8 = '      return data || [];';
                const line9 = '    } catch (error) {';
                const line10 = '      console.warn("Secure API error:", error);';
                const line11 = '      return [];';
                const line12 = '    }';
                const line13 = '  },';
                const line14 = '  async updateRecord(tableId, recordId, changes) {';
                const line15 = '    try {';
                const line16 = '      await parent.window.grist.docApi.applyUserActions([["UpdateRecord", tableId, recordId, changes]]);';
                const line17 = '      return { success: true };';
                const line18 = '    } catch (error) {';
                const line19 = '      return { success: false, error: error.message };';
                const line20 = '    }';
                const line21 = '  },';
                const line22 = '  async addRecord(tableId, record) {';
                const line23 = '    try {';
                const line24 = '      const result = await parent.window.grist.docApi.applyUserActions([["AddRecord", tableId, null, record]]);';
                const line25 = '      return { success: true, id: result.retValues[0] };';
                const line26 = '    } catch (error) {';
                const line27 = '      return { success: false, error: error.message };';
                const line28 = '    }';
                const line29 = '  },';
                const line30 = '  async deleteRecord(tableId, recordId) {';
                const line31 = '    try {';
                const line32 = '      await parent.window.grist.docApi.applyUserActions([["RemoveRecord", tableId, recordId]]);';
                const line33 = '      return { success: true };';
                const line34 = '    } catch (error) {';
                const line35 = '      return { success: false, error: error.message };';
                const line36 = '    }';
                const line37 = '  },';
                const line38 = '  navigate(templateId) {';
                const line39 = '    if (typeof templateId === "string" && templateId.length < 100) {';
                const line40 = '      parent.postMessage({ type: "NAVIGATE", templateId: templateId }, "*");';
                const line41 = '    }';
                const line42 = '  }';
                const line43 = '};';

                let apiCode = '';
                apiCode += line1 + '\n';
                apiCode += line2 + '\n';
                apiCode += line3 + '\n';
                apiCode += line4 + '\n';
                apiCode += line5 + '\n';
                apiCode += line6 + '\n';
                apiCode += line7 + '\n';
                apiCode += line8 + '\n';
                apiCode += line9 + '\n';
                apiCode += line10 + '\n';
                apiCode += line11 + '\n';
                apiCode += line12 + '\n';
                apiCode += line13 + '\n';
                apiCode += line14 + '\n';
                apiCode += line15 + '\n';
                apiCode += line16 + '\n';
                apiCode += line17 + '\n';
                apiCode += line18 + '\n';
                apiCode += line19 + '\n';
                apiCode += line20 + '\n';
                apiCode += line21 + '\n';
                apiCode += line22 + '\n';
                apiCode += line23 + '\n';
                apiCode += line24 + '\n';
                apiCode += line25 + '\n';
                apiCode += line26 + '\n';
                apiCode += line27 + '\n';
                apiCode += line28 + '\n';
                apiCode += line29 + '\n';
                apiCode += line30 + '\n';
                apiCode += line31 + '\n';
                apiCode += line32 + '\n';
                apiCode += line33 + '\n';
                apiCode += line34 + '\n';
                apiCode += line35 + '\n';
                apiCode += line36 + '\n';
                apiCode += line37 + '\n';
                apiCode += line38 + '\n';
                apiCode += line39 + '\n';
                apiCode += line40 + '\n';
                apiCode += line41 + '\n';
                apiCode += line42 + '\n';
                apiCode += line43;

                return apiCode;
            }

            buildErrorDocument(errorMessage) {
                const escapedMessage = this.escapeHtml(errorMessage);
                
                let errorDoc = '';
                errorDoc += '<!DOCTYPE html>\n';
                errorDoc += '<html>\n';
                errorDoc += '<head><meta charset="UTF-8"><title>Template Error</title></head>\n';
                errorDoc += '<body>\n';
                errorDoc += '<div style="padding: 20px; background: #fee2e2; color: #dc2626; border-radius: 8px; margin: 20px;">\n';
                errorDoc += '<h2>üö® Erreur de Template</h2>\n';
                errorDoc += '<p>Message: ' + escapedMessage + '</p>\n';
                errorDoc += '</div>\n';
                errorDoc += '</body>\n';
                errorDoc += '</html>';
                
                return errorDoc;
            }

            setSecurityLevel(level) {
                if (Object.values(this.securityLevels).includes(level)) {
                    this.currentLevel = level;
                    debugLog('SECURITY', 'Niveau de s√©curit√© chang√©: ' + level);
                }
            }
        }

        // SYST√àME PRINCIPAL AVEC DEBUG RENFORC√â
        class SecureGristDashboard {
            constructor() {
                debugLog('DASHBOARD', 'Initialisation SecureGristDashboard');
                this.templates = new Map();
                this.currentTemplate = null;
                this.iframeCounter = 0;
                this.isReady = false;
                this.templatesSource = 'unknown';
                this.secureProcessor = new SecureTemplateProcessor();
                this.validationStats = { processed: 0, errors: 0, warnings: 0 };
                this.initTimeout = null;
            }

            async init() {
                debugLog('INIT', 'D√©but initialisation dashboard');
                
                try {
                    this.updateStatus('debug', 'Initialisation debug...');
                    this.updateLoadingText('Connexion √† Grist...');
                    
                    // Timeout de s√©curit√©
                    this.initTimeout = setTimeout(() => {
                        debugLog('INIT', 'Timeout atteint - utilisation du fallback', null, true);
                        this.useFallback();
                    }, 10000);
                    
                    debugLog('INIT', 'Appel grist.ready()');
                    await grist.ready({ 
                        requiredAccess: 'read table',
                        allowSelectBy: true 
                    });
                    
                    debugLog('INIT', 'Grist ready - chargement configuration');
                    this.updateLoadingText('Chargement des templates...');
                    await this.loadConfiguration();
                    
                    debugLog('INIT', 'Configuration charg√©e - setup navigation');
                    this.updateLoadingText('Configuration de la navigation...');
                    await this.setupNavigation();
                    
                    debugLog('INIT', 'Navigation setup - chargement page par d√©faut');
                    this.updateLoadingText('Chargement de la page par d√©faut...');
                    await this.loadDefaultPage();
                    
                    const statusText = this.templatesSource === 'grist' ? 
                        'Templates compil√©s avec succ√®s' : 
                        'Templates int√©gr√©s actifs';
                    
                    this.updateStatus('secure', statusText);
                    this.hideLoading();
                    this.isReady = true;
                    
                    // Clear timeout
                    if (this.initTimeout) {
                        clearTimeout(this.initTimeout);
                        this.initTimeout = null;
                    }
                    
                    this.logSecurityReport();
                    debugLog('INIT', 'Initialisation termin√©e avec succ√®s');
                    
                } catch (error) {
                    debugLog('INIT', 'Erreur initialisation', error, true);
                    this.updateStatus('error', 'Erreur: ' + error.message);
                    
                    // En cas d'erreur, utiliser le fallback apr√®s 3 secondes
                    setTimeout(() => {
                        this.useFallback();
                    }, 3000);
                }
            }

            useFallback() {
                debugLog('FALLBACK', 'Activation du mode fallback');
                
                if (this.initTimeout) {
                    clearTimeout(this.initTimeout);
                    this.initTimeout = null;
                }
                
                this.templatesSource = 'fallback';
                const fallbackTemplate = createFallbackTemplate();
                this.templates.set(fallbackTemplate.id, fallbackTemplate);
                
                this.setupNavigation();
                this.loadPage(fallbackTemplate.id);
                
                this.updateStatus('debug', 'Mode fallback actif');
                this.hideLoading();
                this.isReady = true;
            }

            updateLoadingText(text) {
                const loadingTextEl = document.getElementById('loading-text');
                if (loadingTextEl) {
                    loadingTextEl.textContent = text;
                }
                debugLog('LOADING', text);
            }

            async loadConfiguration() {
                try {
                    debugLog('CONFIG', 'Tentative de chargement depuis Grist');
                    const gristTemplates = await grist.docApi.fetchTable('Templates');
                    
                    if (gristTemplates && gristTemplates.length > 0) {
                        this.templatesSource = 'grist';
                        debugLog('CONFIG', 'Templates Grist trouv√©s', { count: gristTemplates.length });
                        
                        for (const template of gristTemplates) {
                            this.validationStats.processed++;
                            
                            const validation = this.secureProcessor.validateRawTemplate(template);
                            
                            if (validation.valid) {
                                this.templates.set(validation.cleaned.id, validation.cleaned);
                                debugLog('CONFIG', 'Template valid√©: ' + validation.cleaned.id);
                                
                                if (validation.warnings.length > 0) {
                                    this.validationStats.warnings++;
                                    debugLog('CONFIG', 'Avertissements: ' + validation.warnings.join(', '));
                                }
                            } else {
                                this.validationStats.errors++;
                                debugLog('CONFIG', 'Template rejet√©: ' + template.template_id, validation.errors, true);
                            }
                        }
                    }
                } catch (error) {
                    debugLog('CONFIG', 'Erreur chargement Grist', error, true);
                    throw error; // Re-throw pour d√©clencher le fallback
                }
                
                try {
                    const apps = await grist.docApi.fetchTable('Apps');
                    this.currentApp = apps[0] || { name: 'Dashboard Debug', page: 'dashboard_main' };
                    debugLog('CONFIG', 'App configur√©e', this.currentApp);
                } catch (e) {
                    this.currentApp = { name: 'Dashboard Debug', page: 'dashboard_main' };
                    debugLog('CONFIG', 'App par d√©faut utilis√©e');
                }
                
                document.getElementById('app-title').innerHTML = 
                    'üîí ' + this.currentApp.name + ' <span class="version-badge">v2.5</span><span class="security-badge">DEBUG</span>';
            }

            async setupNavigation() {
                const nav = document.getElementById('navigation');
                if (!nav) return;
                
                nav.innerHTML = '';
                
                const sourceIndicator = document.createElement('span');
                sourceIndicator.style.cssText = 'background: ' + (this.templatesSource === 'grist' ? '#8b5cf6' : this.templatesSource === 'fallback' ? '#f59e0b' : '#6b7280') + '; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; margin-right: 10px;';
                sourceIndicator.textContent = this.templatesSource.toUpperCase() + ' (' + this.templates.size + ')';
                nav.appendChild(sourceIndicator);
                
                for (const template of this.templates.values()) {
                    const btn = document.createElement('button');
                    btn.className = 'nav-btn';
                    btn.textContent = template.name;
                    btn.onclick = () => this.loadPage(template.id);
                    nav.appendChild(btn);
                }
                
                debugLog('NAVIGATION', 'Navigation configur√©e', { 
                    source: this.templatesSource,
                    templatesCount: this.templates.size 
                });
            }

            async loadPage(templateId) {
                if (!this.isReady && this.templatesSource !== 'fallback') return;
                
                try {
                    debugLog('LOAD_PAGE', 'Chargement template: ' + templateId);
                    this.updateStatus('validating', 'Compilation...');
                    
                    const template = this.templates.get(templateId);
                    if (!template) {
                        throw new Error('Template non trouv√©: ' + templateId);
                    }
                    
                    const secureHTML = this.secureProcessor.compileSecureTemplate(template);
                    await this.displayInIframe(secureHTML);
                    
                    const navButtons = document.querySelectorAll('.nav-btn');
                    navButtons.forEach(btn => {
                        btn.classList.toggle('active', btn.textContent === template.name);
                    });
                    
                    this.currentTemplate = templateId;
                    this.updateStatus('secure', 'Template actif');
                    
                    debugLog('LOAD_PAGE', 'Template charg√© avec succ√®s');
                    
                } catch (error) {
                    debugLog('LOAD_PAGE', 'Erreur chargement template', error, true);
                    this.updateStatus('error', 'Erreur');
                    this.showError('Erreur: ' + error.message);
                }
            }

            async displayInIframe(html) {
                const main = document.getElementById('main-content');
                if (!main) return;
                
                const oldContainers = main.querySelectorAll('.iframe-container:not(.active)');
                oldContainers.forEach(container => container.remove());
                
                const currentIframe = main.querySelector('.iframe-container.active');
                if (currentIframe) currentIframe.classList.remove('active');
                
                const container = document.createElement('div');
                container.className = 'iframe-container';
                
                const iframe = document.createElement('iframe');
                iframe.className = 'dynamic-iframe';
                iframe.id = 'secure-iframe-' + (++this.iframeCounter);
                
                container.appendChild(iframe);
                main.appendChild(container);
                
                try {
                    const blob = new Blob([html], { type: 'text/html; charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    iframe.src = url;
                    
                    iframe.onload = () => {
                        container.classList.add('active');
                        setTimeout(() => URL.revokeObjectURL(url), 1000);
                        debugLog('IFRAME', 'Iframe charg√© avec succ√®s');
                    };
                    
                    iframe.onerror = (error) => {
                        debugLog('IFRAME', 'Erreur iframe', error, true);
                    };
                    
                } catch (error) {
                    debugLog('IFRAME', 'Erreur cr√©ation iframe', error, true);
                    this.showError('Erreur iframe');
                }
            }

            async loadDefaultPage() {
                if (this.templates.size === 0) {
                    debugLog('DEFAULT_PAGE', 'Aucun template disponible');
                    return;
                }
                
                const defaultTemplate = this.currentApp.page || Array.from(this.templates.keys())[0];
                if (defaultTemplate && this.templates.has(defaultTemplate)) {
                    await this.loadPage(defaultTemplate);
                } else if (this.templates.size > 0) {
                    await this.loadPage(Array.from(this.templates.keys())[0]);
                }
            }

            updateStatus(type, message) {
                const statusElement = document.getElementById('status');
                if (statusElement) {
                    statusElement.className = 'status-indicator status-' + type;
                    statusElement.textContent = message;
                }
            }

            hideLoading() {
                const loading = document.getElementById('loading');
                if (loading) loading.style.display = 'none';
            }

            showError(message) {
                const main = document.getElementById('main-content');
                if (main) {
                    main.innerHTML = '<div class="error">üîí ' + message + '</div>';
                }
            }

            logSecurityReport() {
                console.log('üîí RAPPORT DE COMPILATION v2.5 DEBUG');
                console.log('   Niveau: ' + this.secureProcessor.currentLevel.toUpperCase());
                console.log('   Templates trait√©s: ' + this.validationStats.processed);
                console.log('   Templates valid√©s: ' + this.templates.size);
                console.log('   Erreurs: ' + this.validationStats.errors);
                console.log('   Avertissements: ' + this.validationStats.warnings);
                console.log('   Source: ' + this.templatesSource.toUpperCase());
                console.log('   Erreurs compilation: ' + window.compilationErrors.length);
                console.log('   Status: MODE DEBUG ACTIF');
            }

            setSecurityLevel(level) {
                this.secureProcessor.setSecurityLevel(level);
                window.securityLevel = level;
                this.updateSecurityUI();
                debugLog('SECURITY', 'Niveau s√©curit√©: ' + level.toUpperCase());
            }

            updateSecurityUI() {
                const securityBtn = document.getElementById('security-btn');
                if (securityBtn) {
                    const level = this.secureProcessor.currentLevel;
                    securityBtn.textContent = 'üîí ' + level.toUpperCase();
                    securityBtn.style.background = level === 'strict' ? '#dc2626' : 
                                                  level === 'moderate' ? '#f59e0b' : '#10b981';
                }
            }
        }

        // FONCTIONS GLOBALES DE DEBUG
        window.toggleDebug = function() {
            window.dashboardDebugMode = !window.dashboardDebugMode;
            const btn = document.getElementById('debug-btn');
            if (btn) {
                btn.style.background = window.dashboardDebugMode ? '#dc2626' : '#f59e0b';
                btn.textContent = window.dashboardDebugMode ? 'üî¥ Debug ON' : 'üêõ Debug';
            }
            debugLog('DEBUG_TOGGLE', 'Debug mode: ' + (window.dashboardDebugMode ? 'ON' : 'OFF'));
        };

        window.toggleSecurity = function() {
            if (!window.dashboard) return;
            
            const levels = ['moderate', 'strict', 'permissive'];
            const currentIndex = levels.indexOf(window.securityLevel);
            const nextLevel = levels[(currentIndex + 1) % levels.length];
            
            window.dashboard.setSecurityLevel(nextLevel);
        };

        // Communication s√©curis√©e
        window.addEventListener('message', (event) => {
            try {
                if (event.data && event.data.type === 'NAVIGATE') {
                    if (window.dashboard && typeof event.data.templateId === 'string') {
                        window.dashboard.loadPage(event.data.templateId);
                    }
                }
            } catch (error) {
                debugLog('MESSAGE', 'Erreur gestion message', error, true);
            }
        });

        // Initialisation avec gestion d'erreur robuste
        document.addEventListener('DOMContentLoaded', () => {
            try {
                debugLog('SYSTEM', 'Initialisation syst√®me v2.5 DEBUG');
                
                window.dashboard = new SecureGristDashboard();
                window.dashboard.init();
                
                const debugBtn = document.getElementById('debug-btn');
                const securityBtn = document.getElementById('security-btn');
                
                if (debugBtn) debugBtn.addEventListener('click', window.toggleDebug);
                if (securityBtn) securityBtn.addEventListener('click', window.toggleSecurity);
                
                debugLog('SYSTEM', 'Syst√®me initialis√© - mode debug actif');
                
            } catch (error) {
                debugLog('SYSTEM', 'Erreur critique initialisation', error, true);
                
                // Fallback d'urgence
                setTimeout(() => {
                    if (window.dashboard) {
                        window.dashboard.useFallback();
                    }
                }, 2000);
            }
        });

        // Capture des erreurs globales
        window.addEventListener('error', (event) => {
            debugLog('GLOBAL_ERROR', 'Erreur JavaScript globale', {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                error: event.error
            }, true);
        });

        window.addEventListener('unhandledrejection', (event) => {
            debugLog('UNHANDLED_PROMISE', 'Promise rejet√©e non g√©r√©e', event.reason, true);
        });
    </script>
</body>
</html>