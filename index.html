<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grist Dynamic Dashboard - v2.2 Secure Fixed</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            height: 100vh;
            display: grid;
            grid-template-rows: 60px 1fr;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1000;
        }
        
        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .version-badge {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .security-badge {
            background: #10b981;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 5px;
        }
        
        .nav {
            margin-left: auto;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .nav-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .nav-btn.active {
            background: rgba(255,255,255,0.4);
            font-weight: 600;
        }
        
        .control-buttons {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }
        
        .control-btn {
            background: #f59e0b;
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .control-btn.security {
            background: #10b981;
        }
        
        .control-btn:hover {
            opacity: 0.8;
        }
        
        .main {
            position: relative;
            overflow: hidden;
        }
        
        .iframe-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1;
        }
        
        .iframe-container.active {
            opacity: 1;
            z-index: 2;
        }
        
        .dynamic-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #64748b;
            z-index: 10;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #fee2e2;
            color: #dc2626;
            padding: 20px;
            border-radius: 8px;
            margin: 20px;
            border-left: 4px solid #dc2626;
            z-index: 100;
            position: relative;
        }
        
        .status-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            z-index: 1001;
        }
        
        .status-loading { background: #fbbf24; color: #92400e; }
        .status-ready { background: #10b981; color: white; }
        .status-error { background: #ef4444; color: white; }
        .status-grist { background: #8b5cf6; color: white; }
        .status-secure { background: #059669; color: white; }
        .status-validating { background: #3b82f6; color: white; }
    </style>
</head>
<body>
    <header class="header">
        <h1 id="app-title">üîí Dashboard Dynamique Grist <span class="version-badge">v2.2</span><span class="security-badge">SECURE</span></h1>
        <nav class="nav" id="navigation"></nav>
        <div class="control-buttons">
            <button class="control-btn security" id="security-btn">üîí MODERATE</button>
            <button class="control-btn" id="debug-btn">üêõ Debug</button>
        </div>
    </header>
    
    <main class="main" id="main-content">
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>Validation s√©curis√©e...</div>
        </div>
        <div class="status-indicator status-loading" id="status">Initialisation s√©curis√©e...</div>
    </main>

    <script>
        // Variables globales
        window.dashboardDebugMode = false;
        window.dashboard = null;
        window.securityLevel = 'moderate';

        // PROCESSEUR DE S√âCURIT√â CORRIG√â
        class SecureTemplateProcessor {
            constructor() {
                this.securityLevels = {
                    STRICT: 'strict',
                    MODERATE: 'moderate', 
                    PERMISSIVE: 'permissive'
                };
                this.currentLevel = this.securityLevels.MODERATE;
            }

            validateRawTemplate(template) {
                const result = { valid: true, errors: [], warnings: [], cleaned: null };

                try {
                    if (!template || typeof template !== 'object') {
                        result.valid = false;
                        result.errors.push('Template invalide ou manquant');
                        return result;
                    }

                    const cleanedTemplate = this.cleanGristColumns(template);
                    
                    const htmlValidation = this.validateHTML(cleanedTemplate.html || '');
                    const cssValidation = this.validateCSS(cleanedTemplate.css || '');
                    const jsValidation = this.validateJavaScript(cleanedTemplate.js || '');

                    result.errors.push(...htmlValidation.errors, ...cssValidation.errors, ...jsValidation.errors);
                    result.warnings.push(...htmlValidation.warnings, ...cssValidation.warnings, ...jsValidation.warnings);
                    
                    if (result.errors.length > 0) {
                        result.valid = false;
                    }

                    result.cleaned = {
                        id: cleanedTemplate.template_id || 'unknown',
                        name: cleanedTemplate.template_name || 'Unnamed',
                        type: cleanedTemplate.type || 'page',
                        table_source: cleanedTemplate.table_source || '',
                        html: htmlValidation.cleaned,
                        css: cssValidation.cleaned,
                        js: jsValidation.cleaned
                    };

                } catch (error) {
                    result.valid = false;
                    result.errors.push('Erreur validation: ' + error.message);
                }

                return result;
            }

            cleanGristColumns(template) {
                const cleaned = {};
                for (const [key, value] of Object.entries(template)) {
                    if (key !== 'A' && key !== 'B' && value !== '' && value !== null && value !== undefined) {
                        cleaned[key] = value;
                    }
                }
                return cleaned;
            }

            validateHTML(html) {
                const result = { valid: true, errors: [], warnings: [], cleaned: '' };
                
                if (!html || typeof html !== 'string') {
                    result.cleaned = '<div style="padding: 20px; text-align: center;">Template HTML vide</div>';
                    return result;
                }

                try {
                    let cleanedHTML = html;

                    if (html.length > 50000) {
                        result.errors.push('HTML trop long: ' + html.length + ' caract√®res');
                        return result;
                    }

                    const dangerousTags = /<(script|iframe|object|embed|form)[^>]*>.*?<\/\1>/gi;
                    if (dangerousTags.test(html)) {
                        result.warnings.push('Balises dangereuses supprim√©es');
                        cleanedHTML = cleanedHTML.replace(dangerousTags, '');
                    }

                    const dangerousAttributes = /\s(on\w+|href\s*=\s*["']javascript:|src\s*=\s*["']javascript:)[^>]*/gi;
                    if (dangerousAttributes.test(cleanedHTML)) {
                        result.warnings.push('Attributs dangereux supprim√©s');
                        cleanedHTML = cleanedHTML.replace(dangerousAttributes, '');
                    }

                    cleanedHTML = this.normalizeWhitespace(cleanedHTML);
                    result.cleaned = cleanedHTML;

                } catch (error) {
                    result.errors.push('Erreur validation HTML: ' + error.message);
                    result.cleaned = '<div class="error">Erreur HTML</div>';
                }

                return result;
            }

            validateCSS(css) {
                const result = { valid: true, errors: [], warnings: [], cleaned: '' };
                
                if (!css || typeof css !== 'string') {
                    return result;
                }

                try {
                    let cleanedCSS = css;

                    if (css.length > 10000) {
                        result.errors.push('CSS trop long: ' + css.length + ' caract√®res');
                        return result;
                    }

                    const dangerousPatterns = /@import\s+.*?(javascript:|expression\()|expression\s*\(|url\s*\(\s*["']?(javascript:|data:)/gi;
                    if (dangerousPatterns.test(css)) {
                        result.warnings.push('Code CSS dangereux neutralis√©');
                        cleanedCSS = cleanedCSS.replace(dangerousPatterns, '/* bloqu√© */');
                    }

                    cleanedCSS = this.normalizeWhitespace(cleanedCSS);
                    result.cleaned = cleanedCSS;

                } catch (error) {
                    result.errors.push('Erreur validation CSS: ' + error.message);
                }

                return result;
            }

            validateJavaScript(js) {
                const result = { valid: true, errors: [], warnings: [], cleaned: '' };
                
                if (!js || typeof js !== 'string') {
                    return result;
                }

                try {
                    let cleanedJS = js;

                    if (js.length > 100000) {
                        result.errors.push('JavaScript trop long: ' + js.length + ' caract√®res');
                        return result;
                    }

                    cleanedJS = this.cleanAccentedCharacters(cleanedJS);

                    const dangerousFunctions = /\b(eval|Function|setTimeout\s*\([^,]*string|setInterval\s*\([^,]*string)\s*\(/gi;
                    if (dangerousFunctions.test(cleanedJS)) {
                        result.warnings.push('Fonctions dangereuses d√©tect√©es');
                        if (this.currentLevel === this.securityLevels.STRICT) {
                            result.errors.push('Code JavaScript non s√©curis√©');
                            return result;
                        }
                    }

                    const parentAccess = /\b(parent\.|top\.|opener\.)/gi;
                    if (parentAccess.test(cleanedJS)) {
                        result.warnings.push('Acc√®s parent neutralis√©');
                        cleanedJS = cleanedJS.replace(parentAccess, 'blocked.');
                    }

                    const syntaxValidation = this.validateJSSyntax(cleanedJS);
                    if (!syntaxValidation.valid) {
                        result.warnings.push('Syntaxe corrig√©e: ' + syntaxValidation.error);
                        cleanedJS = this.wrapInSafeContext(cleanedJS);
                    }

                    cleanedJS = this.normalizeWhitespace(cleanedJS);
                    result.cleaned = cleanedJS;

                } catch (error) {
                    result.errors.push('Erreur validation JS: ' + error.message);
                    result.cleaned = 'console.error("Template JS error: ' + error.message + '");';
                }

                return result;
            }

            cleanAccentedCharacters(text) {
                const charMap = {
                    '√©': 'e', '√®': 'e', '√™': 'e', '√´': 'e', '√†': 'a', '√°': 'a', '√¢': 'a', '√§': 'a',
                    '√π': 'u', '√∫': 'u', '√ª': 'u', '√º': 'u', '√¨': 'i', '√≠': 'i', '√Æ': 'i', '√Ø': 'i',
                    '√≤': 'o', '√≥': 'o', '√¥': 'o', '√∂': 'o', '√ß': 'c', '√±': 'n',
                    '"': '"', '"': '"', ''': "'", ''': "'"
                };
                
                let cleaned = text;
                for (const [accented, clean] of Object.entries(charMap)) {
                    cleaned = cleaned.replace(new RegExp(accented, 'g'), clean);
                }
                
                cleaned = cleaned.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '');
                return cleaned;
            }

            validateJSSyntax(js) {
                try {
                    new Function(js);
                    return { valid: true, error: null };
                } catch (error) {
                    return { valid: false, error: error.message };
                }
            }

            wrapInSafeContext(js) {
                return 'try { ' + js + ' } catch(error) { console.error("Template error:", error); }';
            }

            normalizeWhitespace(text) {
                return text.replace(/\s+/g, ' ').replace(/\n\s*\n/g, '\n').trim();
            }

            // M√âTHODE CORRIG√âE - SANS TEMPLATE LITERALS
            compileSecureTemplate(template) {
                const html = template.html || '<div>Template vide</div>';
                const css = template.css || '';
                const js = template.js || '';
                const gristScript = this.generateSecureGristAPI();
                
                const securityColor = this.currentLevel === 'strict' ? '#dc2626' : 
                                    this.currentLevel === 'moderate' ? '#f59e0b' : '#10b981';

                // CORRECTION: Utilisation de la concat√©nation au lieu des template literals
                return '<!DOCTYPE html>' +
                '<html lang="fr">' +
                '<head>' +
                '<meta charset="UTF-8">' +
                '<meta name="viewport" content="width=device-width, initial-scale=1.0">' +
                '<title>Secure Template ' + template.id + '</title>' +
                '<script src="https://docs.getgrist.com/grist-plugin-api.js"></script>' +
                '<style>' +
                'body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #ffffff; }' +
                '.security-info { position: fixed; top: 10px; right: 10px; background: ' + securityColor + '; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; z-index: 1000; }' +
                css +
                '</style>' +
                '</head>' +
                '<body>' +
                '<div class="security-info">üîí ' + this.currentLevel.toUpperCase() + '</div>' +
                html +
                '<script>' +
                'console.log("üîí Secure Template: ' + template.id + '");' +
                gristScript +
                '(function() {' +
                '"use strict";' +
                js +
                '})();' +
                '</script>' +
                '</body>' +
                '</html>';
            }

            generateSecureGristAPI() {
                return 'window.gristAPI = {' +
                    'async getData(tableName) {' +
                        'try {' +
                            'if (typeof tableName !== "string" || tableName.length > 50) {' +
                                'throw new Error("Table name invalid");' +
                            '}' +
                            'const data = await parent.window.grist.docApi.fetchTable(tableName);' +
                            'return data || [];' +
                        '} catch (error) {' +
                            'console.warn("Secure API error:", error);' +
                            'return [];' +
                        '}' +
                    '},' +
                    'async updateRecord(tableId, recordId, changes) {' +
                        'try {' +
                            'await parent.window.grist.docApi.applyUserActions([["UpdateRecord", tableId, recordId, changes]]);' +
                            'return { success: true };' +
                        '} catch (error) {' +
                            'return { success: false, error: error.message };' +
                        '}' +
                    '},' +
                    'async addRecord(tableId, record) {' +
                        'try {' +
                            'const result = await parent.window.grist.docApi.applyUserActions([["AddRecord", tableId, null, record]]);' +
                            'return { success: true, id: result.retValues[0] };' +
                        '} catch (error) {' +
                            'return { success: false, error: error.message };' +
                        '}' +
                    '},' +
                    'async deleteRecord(tableId, recordId) {' +
                        'try {' +
                            'await parent.window.grist.docApi.applyUserActions([["RemoveRecord", tableId, recordId]]);' +
                            'return { success: true };' +
                        '} catch (error) {' +
                            'return { success: false, error: error.message };' +
                        '}' +
                    '},' +
                    'navigate(templateId) {' +
                        'if (typeof templateId === "string" && templateId.length < 100) {' +
                            'parent.postMessage({ type: "NAVIGATE", templateId: templateId }, "*");' +
                        '}' +
                    '}' +
                '};';
            }

            setSecurityLevel(level) {
                if (Object.values(this.securityLevels).includes(level)) {
                    this.currentLevel = level;
                }
            }
        }

        // SYST√àME PRINCIPAL S√âCURIS√â
        class SecureGristDashboard {
            constructor() {
                this.templates = new Map();
                this.currentTemplate = null;
                this.iframeCounter = 0;
                this.isReady = false;
                this.templatesSource = 'unknown';
                this.secureProcessor = new SecureTemplateProcessor();
                this.validationStats = { processed: 0, errors: 0, warnings: 0 };
            }

            async init() {
                try {
                    window.debugLog('üîí Initializing secure dashboard...');
                    this.updateStatus('validating', 'Validation s√©curis√©e...');
                    
                    await grist.ready({ 
                        requiredAccess: 'read table',
                        allowSelectBy: true 
                    });
                    
                    await this.loadConfiguration();
                    await this.setupNavigation();
                    await this.loadDefaultPage();
                    
                    const statusText = this.templatesSource === 'grist' ? 
                        'Templates s√©curis√©s charg√©s' : 
                        'Templates int√©gr√©s s√©curis√©s';
                    
                    this.updateStatus('secure', statusText);
                    this.hideLoading();
                    this.isReady = true;
                    
                    this.logSecurityReport();
                    
                } catch (error) {
                    console.error('Secure initialization error:', error);
                    this.updateStatus('error', 'Erreur s√©curit√©: ' + error.message);
                    this.showError('Erreur: ' + error.message);
                }
            }

            async loadConfiguration() {
                try {
                    window.debugLog('üîç Loading and validating templates...');
                    const gristTemplates = await grist.docApi.fetchTable('Templates');
                    
                    if (gristTemplates && gristTemplates.length > 0) {
                        this.templatesSource = 'grist';
                        
                        for (const template of gristTemplates) {
                            this.validationStats.processed++;
                            
                            const validation = this.secureProcessor.validateRawTemplate(template);
                            
                            if (validation.valid) {
                                this.templates.set(validation.cleaned.id, validation.cleaned);
                                window.debugLog('‚úÖ Template validated: ' + validation.cleaned.id);
                                
                                if (validation.warnings.length > 0) {
                                    this.validationStats.warnings++;
                                    window.debugLog('‚ö†Ô∏è Warnings for ' + validation.cleaned.id + ':', validation.warnings);
                                }
                            } else {
                                this.validationStats.errors++;
                                console.warn('‚ùå Template rejected: ' + template.template_id, validation.errors);
                            }
                        }
                    }
                } catch (error) {
                    window.debugLog('Error loading Grist templates:', error.message);
                }
                
                if (this.templates.size === 0) {
                    this.templatesSource = 'integrated';
                    const fallbackTemplate = {
                        id: 'secure_fallback',
                        name: 'üîí Fallback S√©curis√©',
                        type: 'dashboard',
                        html: '<div style="padding: 20px; text-align: center; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 12px;"><h1>üîí Mode S√©curis√© Actif</h1><p>Syst√®me op√©rationnel avec validation compl√®te</p></div>',
                        css: '',
                        js: 'console.log("Secure fallback template loaded");'
                    };
                    this.templates.set(fallbackTemplate.id, fallbackTemplate);
                }
                
                try {
                    const apps = await grist.docApi.fetchTable('Apps');
                    this.currentApp = apps[0] || { name: 'Dashboard S√©curis√©', page: 'dashboard_main' };
                } catch (e) {
                    this.currentApp = { name: 'Dashboard S√©curis√©', page: 'dashboard_main' };
                }
                
                document.getElementById('app-title').innerHTML = 
                    'üîí ' + this.currentApp.name + ' <span class="version-badge">v2.2</span><span class="security-badge">SECURE</span>';
            }

            async setupNavigation() {
                const nav = document.getElementById('navigation');
                if (!nav) return;
                
                nav.innerHTML = '';
                
                const sourceIndicator = document.createElement('span');
                sourceIndicator.style.cssText = 'background: ' + (this.templatesSource === 'grist' ? '#8b5cf6' : '#6b7280') + '; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; margin-right: 10px;';
                sourceIndicator.textContent = (this.templatesSource === 'grist' ? 'GRIST' : 'INT√âGR√â') + ' (' + this.templates.size + ')';
                nav.appendChild(sourceIndicator);
                
                for (const template of this.templates.values()) {
                    const btn = document.createElement('button');
                    btn.className = 'nav-btn';
                    btn.textContent = template.name;
                    btn.onclick = () => this.loadPage(template.id);
                    nav.appendChild(btn);
                }
            }

            async loadPage(templateId) {
                if (!this.isReady) return;
                
                try {
                    this.updateStatus('validating', 'Compilation s√©curis√©e...');
                    
                    const template = this.templates.get(templateId);
                    if (!template) {
                        throw new Error('Template non trouv√©: ' + templateId);
                    }
                    
                    window.debugLog('üîí Loading secure template: ' + template.id);
                    
                    const secureHTML = this.secureProcessor.compileSecureTemplate(template);
                    await this.displayInIframe(secureHTML);
                    
                    const navButtons = document.querySelectorAll('.nav-btn');
                    navButtons.forEach(btn => {
                        btn.classList.toggle('active', btn.textContent === template.name);
                    });
                    
                    this.currentTemplate = templateId;
                    this.updateStatus('secure', 'Template s√©curis√© actif');
                    
                } catch (error) {
                    console.error('Secure template loading error:', error);
                    this.updateStatus('error', 'Erreur s√©curit√©');
                    this.showError('Erreur: ' + error.message);
                }
            }

            async displayInIframe(html) {
                const main = document.getElementById('main-content');
                if (!main) return;
                
                const oldContainers = main.querySelectorAll('.iframe-container:not(.active)');
                oldContainers.forEach(container => container.remove());
                
                const currentIframe = main.querySelector('.iframe-container.active');
                if (currentIframe) currentIframe.classList.remove('active');
                
                const container = document.createElement('div');
                container.className = 'iframe-container';
                
                const iframe = document.createElement('iframe');
                iframe.className = 'dynamic-iframe';
                iframe.id = 'secure-iframe-' + (++this.iframeCounter);
                
                container.appendChild(iframe);
                main.appendChild(container);
                
                try {
                    const blob = new Blob([html], { type: 'text/html; charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    iframe.src = url;
                    
                    iframe.onload = () => {
                        container.classList.add('active');
                        setTimeout(() => URL.revokeObjectURL(url), 1000);
                    };
                    
                } catch (error) {
                    console.error('Secure iframe error:', error);
                    this.showError('Erreur iframe s√©curis√©');
                }
            }

            async loadDefaultPage() {
                const defaultTemplate = this.currentApp.page || Array.from(this.templates.keys())[0];
                if (defaultTemplate && this.templates.has(defaultTemplate)) {
                    await this.loadPage(defaultTemplate);
                } else if (this.templates.size > 0) {
                    await this.loadPage(Array.from(this.templates.keys())[0]);
                }
            }

            updateStatus(type, message) {
                const statusElement = document.getElementById('status');
                if (statusElement) {
                    statusElement.className = 'status-indicator status-' + type;
                    statusElement.textContent = message;
                }
            }

            hideLoading() {
                const loading = document.getElementById('loading');
                if (loading) loading.style.display = 'none';
            }

            showError(message) {
                const main = document.getElementById('main-content');
                if (main) {
                    main.innerHTML = '<div class="error">üîí ' + message + '<br><small>Syst√®me s√©curis√© - Erreur contr√¥l√©e</small></div>';
                }
            }

            logSecurityReport() {
                console.log('üîí RAPPORT DE S√âCURIT√â');
                console.log('   Niveau: ' + this.secureProcessor.currentLevel.toUpperCase());
                console.log('   Templates trait√©s: ' + this.validationStats.processed);
                console.log('   Templates valid√©s: ' + this.templates.size);
                console.log('   Erreurs: ' + this.validationStats.errors);
                console.log('   Avertissements: ' + this.validationStats.warnings);
                console.log('   Source: ' + this.templatesSource.toUpperCase());
            }

            setSecurityLevel(level) {
                this.secureProcessor.setSecurityLevel(level);
                window.securityLevel = level;
                this.updateSecurityUI();
                window.debugLog('üîí Security level changed to: ' + level.toUpperCase());
            }

            updateSecurityUI() {
                const securityBtn = document.getElementById('security-btn');
                if (securityBtn) {
                    const level = this.secureProcessor.currentLevel;
                    securityBtn.textContent = 'üîí ' + level.toUpperCase();
                    securityBtn.style.background = level === 'strict' ? '#dc2626' : 
                                                  level === 'moderate' ? '#f59e0b' : '#10b981';
                }
            }
        }

        // FONCTIONS GLOBALES ET INITIALISATION
        window.toggleDebug = function() {
            window.dashboardDebugMode = !window.dashboardDebugMode;
            const btn = document.getElementById('debug-btn');
            if (btn) {
                btn.style.background = window.dashboardDebugMode ? '#dc2626' : '#f59e0b';
                btn.textContent = window.dashboardDebugMode ? 'üî¥ Debug ON' : 'üêõ Debug';
            }
            console.log('üêõ Debug mode:', window.dashboardDebugMode ? 'ON' : 'OFF');
        };

        window.toggleSecurity = function() {
            if (!window.dashboard) return;
            
            const levels = ['moderate', 'strict', 'permissive'];
            const currentIndex = levels.indexOf(window.securityLevel);
            const nextLevel = levels[(currentIndex + 1) % levels.length];
            
            window.dashboard.setSecurityLevel(nextLevel);
        };

        window.debugLog = function(message, data) {
            if (window.dashboardDebugMode) {
                console.log('[üîí SECURE DEBUG]', message, data || '');
            }
        };

        // Communication s√©curis√©e avec les iframes
        window.addEventListener('message', (event) => {
            try {
                if (event.data && event.data.type === 'NAVIGATE') {
                    if (window.dashboard && typeof event.data.templateId === 'string') {
                        window.dashboard.loadPage(event.data.templateId);
                    }
                }
            } catch (error) {
                console.error('Secure message handling error:', error);
            }
        });

        // Initialisation s√©curis√©e
        document.addEventListener('DOMContentLoaded', () => {
            try {
                window.dashboard = new SecureGristDashboard();
                window.dashboard.init();
                
                const debugBtn = document.getElementById('debug-btn');
                const securityBtn = document.getElementById('security-btn');
                
                if (debugBtn) debugBtn.addEventListener('click', window.toggleDebug);
                if (securityBtn) securityBtn.addEventListener('click', window.toggleSecurity);
                
                window.debugLog('üîí Secure system initialized');
                
            } catch (error) {
                console.error('Secure initialization error:', error);
            }
        });
    </script>
</body>
</html>